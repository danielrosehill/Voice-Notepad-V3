name: Build Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  # Extract version from tag or input
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            # Extract version from tag (v1.2.3 -> 1.2.3)
            echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT
          fi

  # Build Linux packages
  build-linux:
    needs: prepare
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3 python3-venv python3-pip \
            ffmpeg portaudio19-dev \
            fuse libfuse2

      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Add uv to PATH
        run: echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Build Debian package
        run: ./build.sh ${{ needs.prepare.outputs.version }}

      - name: Build AppImage
        run: ./build-appimage.sh ${{ needs.prepare.outputs.version }}

      - name: Build Tarball
        run: ./build-tarball.sh ${{ needs.prepare.outputs.version }}

      - name: Generate checksums
        run: |
          cd dist
          sha256sum *.deb *.AppImage *.tar.gz > SHA256SUMS-linux.txt

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: |
            dist/*.deb
            dist/*.AppImage
            dist/*.tar.gz
            dist/SHA256SUMS-linux.txt

  # Build Windows installer
  build-windows:
    needs: prepare
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install ffmpeg
        run: choco install ffmpeg -y

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r app/requirements.txt
          pip install pyinstaller pillow

      - name: Create Windows icon
        run: |
          python -c "
          from PIL import Image, ImageDraw
          # Create a simple microphone icon
          sizes = [16, 32, 48, 64, 128, 256]
          images = []
          for size in sizes:
              img = Image.new('RGBA', (size, size), (0, 0, 0, 0))
              draw = ImageDraw.Draw(img)
              # Red microphone shape
              cx, cy = size // 2, size // 2
              # Mic body
              r = size // 4
              draw.ellipse([cx-r, cy-r*2, cx+r, cy], fill='#dc3545')
              draw.rectangle([cx-r, cy-r, cx+r, cy+r//2], fill='#dc3545')
              # Stand
              draw.rectangle([cx-2, cy+r//2, cx+2, cy+r], fill='#dc3545')
              draw.arc([cx-r, cy+r//2, cx+r, cy+r*2], 0, 180, fill='#dc3545', width=max(1, size//16))
              images.append(img)
          images[0].save('voice-notepad.ico', format='ICO', sizes=[(s,s) for s in sizes], append_images=images[1:])
          "
        shell: pwsh

      - name: Build with PyInstaller
        run: |
          pyinstaller --name "Voice Notepad" `
            --windowed `
            --onedir `
            --icon=voice-notepad.ico `
            --add-data "app/src;src" `
            --hidden-import=pynput.keyboard._win32 `
            --hidden-import=pynput.mouse._win32 `
            --hidden-import=PIL `
            --collect-all google.genai `
            --collect-all mistralai `
            --collect-all httpx `
            app/src/main.py
        shell: pwsh

      - name: Create ZIP archive
        run: |
          $version = "${{ needs.prepare.outputs.version }}"
          Compress-Archive -Path "dist/Voice Notepad" -DestinationPath "dist/Voice-Notepad-${version}-windows-x64.zip"
        shell: pwsh

      - name: Generate checksum
        run: |
          cd dist
          $hash = Get-FileHash "Voice-Notepad-${{ needs.prepare.outputs.version }}-windows-x64.zip" -Algorithm SHA256
          "$($hash.Hash)  Voice-Notepad-${{ needs.prepare.outputs.version }}-windows-x64.zip" | Out-File -Encoding ASCII SHA256SUMS-windows.txt
        shell: pwsh

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-packages
          path: |
            dist/*.zip
            dist/SHA256SUMS-windows.txt

  # Create GitHub Release
  release:
    needs: [prepare, build-linux, build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-packages
          path: dist/

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-packages
          path: dist/

      - name: Combine checksums
        run: |
          cd dist
          cat SHA256SUMS-linux.txt SHA256SUMS-windows.txt > SHA256SUMS.txt
          rm SHA256SUMS-linux.txt SHA256SUMS-windows.txt

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Voice Notepad v${{ needs.prepare.outputs.version }}
          body: |
            ## Voice Notepad v${{ needs.prepare.outputs.version }}

            Voice recording with AI-powered transcription and cleanup using multimodal AI models.

            ### Downloads

            | Platform | Package | Description |
            |----------|---------|-------------|
            | **Linux (Debian/Ubuntu)** | `voice-notepad_${{ needs.prepare.outputs.version }}_amd64.deb` | Install with `sudo dpkg -i` |
            | **Linux (Universal)** | `Voice_Notepad-${{ needs.prepare.outputs.version }}-x86_64.AppImage` | Run directly, works on any distro |
            | **Linux (Portable)** | `voice-notepad-${{ needs.prepare.outputs.version }}-linux-x86_64.tar.gz` | Extract and run |
            | **Windows** | `Voice-Notepad-${{ needs.prepare.outputs.version }}-windows-x64.zip` | Extract and run `Voice Notepad.exe` |

            ### Requirements

            - **Linux**: ffmpeg, portaudio (`sudo apt install ffmpeg portaudio19-dev`)
            - **Windows**: No additional requirements

            ### First Run

            1. Launch the app
            2. Go to Settings and add your API key (OpenRouter recommended)
            3. Start recording!

            ### Checksums

            See `SHA256SUMS.txt` for verification.
          draft: false
          prerelease: false
          files: |
            dist/*.deb
            dist/*.AppImage
            dist/*.tar.gz
            dist/*.zip
            dist/SHA256SUMS.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
